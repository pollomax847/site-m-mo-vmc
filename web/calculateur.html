<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculateur de débits - Mémo Technique VMC</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="styles/content.css?v=2.0">
  <link rel="stylesheet" href="styles/mobile-fixes.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    .result-box { background: #f8f9fa; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
    .history-item { border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; margin-bottom: 10px; }
    .history-item:hover { background-color: #f8f9fa; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">Mémo Technique VMC</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="index.html">Accueil</a></li>
          <li class="nav-item"><a class="nav-link" href="simple-flux.html">VMC Simple Flux</a></li>
          <li class="nav-item"><a class="nav-link" href="double-flux.html">VMC Double Flux</a></li>
          <li class="nav-item"><a class="nav-link active" href="#">Calculateur de débits</a></li>
        </ul>
        <button class="btn btn-outline-light" id="themeToggle">
          <i class="fas fa-moon"></i> Mode sombre
        </button>
      </div>
    </div>
  </nav>
  <div class="container">
    <h1 class="mb-4">Calculateur de débits réglementaires</h1>
    <form id="calcForm">
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="vmcType" class="form-label">Type de VMC</label>
          <select class="form-select" id="vmcType" required>
            <option value="">Choisir...</option>
            <option value="simple-flux">Simple Flux</option>
            <option value="hygro-a">Hygro A</option>
            <option value="hygro-b">Hygro B</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="housingType" class="form-label">Type de logement</label>
          <select class="form-select" id="housingType" required>
            <option value="">Choisir...</option>
            <option value="T1">T1</option>
            <option value="T2">T2</option>
            <option value="T3">T3</option>
            <option value="T4">T4</option>
            <option value="T5+">T5+</option>
          </select>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="cuisine" class="form-label">Nombre de cuisines</label>
          <input type="number" class="form-control" id="cuisine" min="0" value="0">
        </div>
        <div class="col-md-3">
          <label for="sdb" class="form-label">Nombre de salles de bain</label>
          <input type="number" class="form-control" id="sdb" min="0" value="0">
        </div>
        <div class="col-md-3">
          <label for="wc" class="form-label">Nombre de WC</label>
          <input type="number" class="form-control" id="wc" min="0" value="0">
        </div>
        <div class="col-md-3">
          <label for="autreSdb" class="form-label">Autres salles d'eau</label>
          <input type="number" class="form-control" id="autreSdb" min="0" value="0">
        </div>
      </div>
      <button type="submit" class="btn btn-primary me-2">Calculer</button>
      <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">Effacer</button>
    </form>
    <div id="results" class="result-box d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Résultats</h3>
        <button class="btn btn-sm btn-success" onclick="exportToPDF()">Exporter PDF</button>
      </div>
      <div id="resultsContent"></div>
    </div>
    
    <div class="mt-4">
      <h4>Historique des calculs</h4>
      <div id="historyContainer"></div>
      <button class="btn btn-outline-danger btn-sm mt-2" onclick="clearHistory()">Effacer l'historique</button>
    </div>
    
    <a href="index.html" class="btn btn-secondary mt-4">Retour à l'accueil</a>
  </div>
  <script>
    // Dark mode functionality
    document.addEventListener('DOMContentLoaded', function() {
      const themeToggle = document.getElementById('themeToggle');
      const body = document.body;
      
      // Load saved theme
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        body.classList.add('dark-theme');
        updateThemeButton(true);
      }
      
      themeToggle.addEventListener('click', function() {
        const isDark = body.classList.toggle('dark-theme');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        updateThemeButton(isDark);
      });
      
      function updateThemeButton(isDark) {
        const icon = themeToggle.querySelector('i');
        const text = themeToggle.querySelector('span') || themeToggle;
        if (isDark) {
          icon.className = 'fas fa-sun';
          text.innerHTML = '<i class="fas fa-sun"></i> Mode clair';
          themeToggle.className = 'btn btn-outline-light';
        } else {
          icon.className = 'fas fa-moon';
          text.innerHTML = '<i class="fas fa-moon"></i> Mode sombre';
          themeToggle.className = 'btn btn-outline-dark';
        }
      }
    });
  </script>
  <script>
    const debitsReglementaires = {
      'simple-flux': { 'cuisine': 75, 'salle-de-bain': 50, 'wc': 30, 'autre-sdb': 50 },
      'hygro-a': { 'cuisine': 75, 'salle-de-bain': 50, 'wc': 30, 'autre-sdb': 50 },
      'hygro-b': { 'cuisine': 75, 'salle-de-bain': 50, 'wc': 30, 'autre-sdb': 50 }
    };
    const minimumDebitsParLogement = { 'T1': 100, 'T2': 150, 'T3': 200, 'T4': 250, 'T5+': 300 };
    
    // Load history on page load
    document.addEventListener('DOMContentLoaded', loadHistory);
    
    document.getElementById('calcForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const vmcType = document.getElementById('vmcType').value;
      const housingType = document.getElementById('housingType').value;
      
      if (!vmcType || !housingType) {
        alert('Veuillez sélectionner le type de VMC et de logement');
        return;
      }
      
      const cuisine = parseInt(document.getElementById('cuisine').value) || 0;
      const sdb = parseInt(document.getElementById('sdb').value) || 0;
      const wc = parseInt(document.getElementById('wc').value) || 0;
      const autreSdb = parseInt(document.getElementById('autreSdb').value) || 0;
      
      if (cuisine + sdb + wc + autreSdb === 0) {
        alert('Veuillez entrer au moins un nombre de pièces');
        return;
      }
      
      const flows = debitsReglementaires[vmcType];
      const results = {
        'Cuisine': cuisine * flows['cuisine'],
        'Salle de bain': sdb * flows['salle-de-bain'],
        'WC': wc * flows['wc'],
        'Autre salle d\'eau': autreSdb * flows['autre-sdb']
      };
      const total = Object.values(results).reduce((a, b) => a + b, 0);
      const minFlow = minimumDebitsParLogement[housingType];
      
      // Save to history
      const calculation = {
        vmcType: vmcType,
        housingType: housingType,
        inputs: { cuisine, sdb, wc, autreSdb },
        results: results,
        total: total,
        minFlow: minFlow,
        timestamp: new Date().toLocaleString('fr-FR')
      };
      saveCalculation(calculation);
      
      displayResults(results, total, minFlow);
    });
    
    function displayResults(results, total, minFlow) {
      let html = `<ul class='mb-3'>`;
      for (const [piece, val] of Object.entries(results)) {
        html += `<li><strong>${piece}</strong> : ${val} m³/h</li>`;
      }
      html += `</ul><p><strong>Débit total</strong> : ${total} m³/h</p>`;
      html += `<p><strong>Débit minimal réglementaire</strong> : ${minFlow} m³/h</p>`;
      html += `<p class='${total >= minFlow ? 'text-success' : 'text-danger'}'><strong>${total >= minFlow ? 'Conforme' : 'Non conforme'}</strong></p>`;
      
      const resDiv = document.getElementById('results');
      document.getElementById('resultsContent').innerHTML = html;
      resDiv.classList.remove('d-none');
    }
    
    function saveCalculation(calculation) {
      let history = JSON.parse(localStorage.getItem('vmcCalculations') || '[]');
      history.unshift(calculation);
      if (history.length > 10) history = history.slice(0, 10);
      localStorage.setItem('vmcCalculations', JSON.stringify(history));
      loadHistory();
    }
    
    function loadHistory() {
      const history = JSON.parse(localStorage.getItem('vmcCalculations') || '[]');
      const container = document.getElementById('historyContainer');
      container.innerHTML = '';
      
      if (history.length === 0) {
        container.innerHTML = '<p class="text-muted">Aucun calcul enregistré</p>';
        return;
      }
      
      history.forEach((calc, index) => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>${calc.vmcType} - ${calc.housingType}</strong> (${calc.timestamp})
              <br><small>Débit total: ${calc.total} m³/h</small>
            </div>
            <div>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="loadCalculation(${index})">Charger</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteCalculation(${index})">×</button>
            </div>
          </div>
        `;
        container.appendChild(item);
      });
    }
    
    function loadCalculation(index) {
      const history = JSON.parse(localStorage.getItem('vmcCalculations') || '[]');
      const calc = history[index];
      
      document.getElementById('vmcType').value = calc.vmcType;
      document.getElementById('housingType').value = calc.housingType;
      document.getElementById('cuisine').value = calc.inputs.cuisine;
      document.getElementById('sdb').value = calc.inputs.sdb;
      document.getElementById('wc').value = calc.inputs.wc;
      document.getElementById('autreSdb').value = calc.inputs.autreSdb;
      
      displayResults(calc.results, calc.total, calc.minFlow);
    }
    
    function deleteCalculation(index) {
      let history = JSON.parse(localStorage.getItem('vmcCalculations') || '[]');
      history.splice(index, 1);
      localStorage.setItem('vmcCalculations', JSON.stringify(history));
      loadHistory();
    }
    
    function clearHistory() {
      if (confirm('Voulez-vous effacer tout l\'historique ?')) {
        localStorage.removeItem('vmcCalculations');
        loadHistory();
      }
    }
    
    function clearForm() {
      document.getElementById('calcForm').reset();
      document.getElementById('results').classList.add('d-none');
    }
    
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(20);
      doc.text('Rapport de calcul VMC', 20, 30);
      
      const vmcType = document.getElementById('vmcType').options[document.getElementById('vmcType').selectedIndex].text;
      const housingType = document.getElementById('housingType').value;
      
      doc.setFontSize(12);
      doc.text(`Type de VMC: ${vmcType}`, 20, 50);
      doc.text(`Type de logement: ${housingType}`, 20, 60);
      
      const results = document.querySelectorAll('#resultsContent li');
      let y = 80;
      results.forEach(result => {
        doc.text(result.textContent, 20, y);
        y += 10;
      });
      
      const total = document.querySelector('#resultsContent p:nth-child(2)').textContent;
      const min = document.querySelector('#resultsContent p:nth-child(3)').textContent;
      const status = document.querySelector('#resultsContent p:last-child').textContent;
      
      doc.text(total, 20, y);
      doc.text(min, 20, y + 10);
      doc.text(status, 20, y + 20);
      
      doc.save('rapport-vmc.pdf');
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
